<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiceBear Avatar Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script>
        // Check system preference and set dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // Listen for changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        /* Custom animations and utilities for Tailwind */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        
        .animate-blob {
            animation: blob 7s infinite;
        }
        
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        
        .animation-delay-4000 {
            animation-delay: 4s;
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }

        /* Style Option Styling */
        .style-option {
            background-color: white;
            border-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
        }
        .dark .style-option {
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            color: #cbd5e1; /* slate-300 */
        }
        .style-option:hover {
            border-color: #cbd5e1; /* slate-300 */
            color: #1e293b; /* slate-800 */
        }
        .dark .style-option:hover {
            border-color: #475569; /* slate-600 */
            color: #f8fafc; /* slate-50 */
        }
        .style-option.active {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-700 */
        }
        .dark .style-option.active {
            background-color: #1e3a8a; /* blue-900 */
            border-color: #3b82f6; /* blue-500 */
            color: #bfdbfe; /* blue-200 */
        }
        
        /* Color picker container styling */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans leading-relaxed selection:bg-blue-100 selection:text-blue-700 dark:bg-slate-900 dark:text-slate-100 dark:selection:bg-blue-900 dark:selection:text-blue-100">
    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200/60 px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm transition-all duration-300 dark:bg-slate-900/80 dark:border-slate-700/60">
        <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2 tracking-tight dark:text-white">
            <div class="p-2 bg-blue-50 rounded-xl text-blue-600 dark:bg-blue-900/30 dark:text-blue-400">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.049 12.525a3 3 0 01-2.12-2.12m2.12 2.12a3 3 0 002.12-2.12m-2.12 2.12c.412-.412.833-.833 1.255-1.255m7.555-12.55a3 3 0 00-2.12-2.12m2.12 2.12a3 3 0 012.12-2.12m-2.12 2.12c-.412.412-.833.833-1.255 1.255m-7.555 12.55a3 3 0 01-2.12 2.12m2.12-2.12a3 3 0 002.12 2.12m-2.12-2.12c.412-.412.833-.833 1.255-1.255" />
                </svg>
            </div>
            Basher Editor
        </h1>
        <div class="flex gap-3">
            <button onclick="randomizeAvatar()" class="px-4 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50 hover:border-slate-300 hover:text-slate-900 transition-all shadow-sm hover:shadow flex items-center gap-2 active:scale-95 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700 dark:hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Random
            </button>
            <button onclick="downloadAvatar()" class="px-4 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg shadow-blue-500/20 flex items-center gap-2 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Download
            </button>
        </div>
    </header>
    
    <div class="grid lg:grid-cols-[380px_1fr] h-[calc(100vh-73px)]">
        <aside class="bg-white/50 backdrop-blur-sm border-r border-slate-200/60 overflow-y-auto h-[calc(100vh-73px)] lg:h-auto dark:bg-slate-900/50 dark:border-slate-700/60">
            <!-- Avatar Style Selection -->
            <div class="border-b border-slate-100 p-6 dark:border-slate-800">
                <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider dark:text-slate-500">Avatar Style</h3>
                <div class="flex gap-2 mb-4 flex-wrap" id="styleSelector">
                    <div class="style-option active px-4 py-2.5 border rounded-xl cursor-pointer text-sm font-medium transition-all shadow-sm hover:shadow-md active:scale-95" data-style="lorelei">Lorelei</div>
                </div>
            </div>
            
            <!-- Basic Settings -->
            <div class="border-b border-slate-100 p-6 dark:border-slate-800">
                <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider dark:text-slate-500">Basic Settings</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2 dark:text-slate-300" for="seedInput">Seed</label>
                        <div class="relative">
                            <input type="text" id="seedInput" class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm dark:bg-slate-800 dark:border-slate-700 dark:text-slate-100 dark:focus:ring-blue-500/20" value="custom-avatar" placeholder="Enter seed">
                            <div class="absolute right-3 top-2.5 text-slate-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300" for="sizeInput">Size</label>
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md dark:bg-slate-800 dark:text-slate-400" id="sizeValue">200px</span>
                        </div>
                        <input type="range" id="sizeInput" class="w-full my-2" min="50" max="500" value="200">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300" for="scaleInput">Scale</label>
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md dark:bg-slate-800 dark:text-slate-400" id="scaleValue">100%</span>
                        </div>
                        <input type="range" id="scaleInput" class="w-full my-2" min="50" max="200" value="100">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300" for="rotateInput">Rotate</label>
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md dark:bg-slate-800 dark:text-slate-400" id="rotateValue">0°</span>
                        </div>
                        <input type="range" id="rotateInput" class="w-full my-2" min="0" max="360" value="0">
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300" for="radiusInput">Border Radius</label>
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md dark:bg-slate-800 dark:text-slate-400" id="radiusValue">0%</span>
                        </div>
                        <input type="range" id="radiusInput" class="w-full my-2" min="0" max="50" value="0">
                    </div>
                </div>
            </div>
            
            <!-- Background -->
            <div class="border-b border-slate-100 p-6 dark:border-slate-800">
                <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider dark:text-slate-500">Background</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2 dark:text-slate-300">Background Type</label>
                        <div class="relative">
                            <select id="backgroundType" class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all shadow-sm appearance-none dark:bg-slate-800 dark:border-slate-700 dark:text-slate-100">
                                <option value="solid">Solid Color</option>
                                <option value="gradientLinear">Linear Gradient</option>
                            </select>
                            <div class="absolute right-3 top-3 text-slate-400 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">Background Colors</label>
                        <div class="space-y-1" id="backgroundColors">
                            <!-- Colors will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hair -->
            <div class="border-b border-slate-100 p-6">
                <h3 class="text-sm font-semibold text-gray-600 mb-4 uppercase tracking-wide">Hair</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Hair Style</label>
                        <div id="hairStyles">
                            <!-- Hair styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Hair Accessories</label>
                        <div id="hairAccessoriesStyles">
                            <!-- Hair accessories will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Facial Features -->
            <div class="border-b border-slate-100 p-6">
                <h3 class="text-sm font-semibold text-gray-600 mb-4 uppercase tracking-wide">Face</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Head Shape</label>
                        <div id="headStyles">
                            <!-- Head styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Eyes</label>
                        <div id="eyeStyles">
                            <!-- Eye styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Eyebrows</label>
                        <div id="eyebrowStyles">
                            <!-- Eyebrow styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Nose</label>
                        <div id="noseStyles">
                            <!-- Nose styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Mouth</label>
                        <div id="mouthStyles">
                            <!-- Mouth styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Freckles</label>
                        <div id="frecklesStyles">
                            <!-- Freckles styles will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Accessories -->
            <div class="border-b border-slate-100 p-6">
                <h3 class="text-sm font-semibold text-gray-600 mb-4 uppercase tracking-wide">Accessories</h3>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Glasses</label>
                        <div id="glassesStyles">
                            <!-- Glasses styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Earrings</label>
                        <div id="earringsStyles">
                            <!-- Earrings styles will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Beard</label>
                        <div id="beardStyles">
                            <!-- Beard styles will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="p-8 flex flex-col items-center justify-center bg-slate-50/50 relative overflow-hidden dark:bg-slate-900/50">
            <!-- Decorative background elements -->
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-200/20 rounded-full blur-3xl mix-blend-multiply animate-blob dark:bg-blue-900/20 dark:mix-blend-normal"></div>
                <div class="absolute top-1/3 right-1/4 w-96 h-96 bg-purple-200/20 rounded-full blur-3xl mix-blend-multiply animate-blob animation-delay-2000 dark:bg-purple-900/20 dark:mix-blend-normal"></div>
                <div class="absolute bottom-1/4 left-1/3 w-96 h-96 bg-pink-200/20 rounded-full blur-3xl mix-blend-multiply animate-blob animation-delay-4000 dark:bg-pink-900/20 dark:mix-blend-normal"></div>
            </div>

            <div class="bg-white/80 backdrop-blur-xl border border-white/50 rounded-3xl p-12 mb-8 flex items-center justify-center min-h-[400px] min-w-[400px] shadow-[0_8px_30px_rgb(0,0,0,0.04)] relative z-10 transition-all hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)] dark:bg-slate-800/80 dark:border-slate-700/50 dark:shadow-[0_8px_30px_rgb(0,0,0,0.2)]">
                <img id="avatarImage" src="" alt="Avatar Preview" class="rounded-2xl drop-shadow-2xl hidden transition-all duration-500 hover:scale-105">
                <div id="loadingIndicator" class="w-8 h-8 border-4 border-blue-100 border-t-4 border-t-blue-500 rounded-full loading dark:border-slate-700 dark:border-t-blue-500"></div>
            </div>
            
            <div class="flex gap-3 flex-wrap justify-center relative z-10">
                <button onclick="copyToClipboard()" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50 hover:text-slate-900 transition-all shadow-sm hover:shadow flex items-center gap-2 active:scale-95 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700 dark:hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                    </svg>
                    Copy URL
                </button>
                <button onclick="downloadSVG()" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50 hover:text-slate-900 transition-all shadow-sm hover:shadow flex items-center gap-2 active:scale-95 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700 dark:hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                    </svg>
                    SVG
                </button>
                <button onclick="downloadPNG()" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-200 rounded-xl text-sm font-semibold hover:bg-slate-50 hover:text-slate-900 transition-all shadow-sm hover:shadow flex items-center gap-2 active:scale-95 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700 dark:hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a2.25 2.25 0 002.25-2.25V6a2.25 2.25 0 00-2.25-2.25H3.75A2.25 2.25 0 001.5 6v12a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                    PNG
                </button>
                <button onclick="generateNewSeed()" class="px-5 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-semibold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 flex items-center gap-2 active:scale-95 dark:bg-blue-600 dark:hover:bg-blue-700 dark:shadow-blue-900/20">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                    </svg>
                    New Avatar
                </button>
            </div>
            
            <div class="bg-white/50 backdrop-blur-sm border border-slate-200 rounded-xl p-4 mt-8 w-full max-w-2xl relative z-10 dark:bg-slate-800/50 dark:border-slate-700">
                <label for="avatarUrl" class="text-xs font-bold text-slate-400 block mb-2 uppercase tracking-wider dark:text-slate-500">Avatar URL</label>
                <div class="relative">
                    <input type="text" id="avatarUrl" readonly class="w-full pl-4 pr-10 py-2.5 border border-slate-200 rounded-lg text-sm font-mono bg-white text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:bg-slate-900 dark:border-slate-700 dark:text-slate-300 dark:focus:ring-blue-500/20">
                    <div class="absolute right-3 top-2.5 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration for different avatar styles and their options
        const avatarConfigs = {
            lorelei: {
                hair: Array.from({length: 48}, (_, i) => `variant${String(i + 1).padStart(2, '0')}`),
                eyes: Array.from({length: 24}, (_, i) => `variant${String(i + 1).padStart(2, '0')}`),
                eyebrows: Array.from({length: 13}, (_, i) => `variant${String(i + 1).padStart(2, '0')}`),
                nose: Array.from({length: 6}, (_, i) => `variant${String(i + 1).padStart(2, '0')}`),
                mouth: [
                    'happy01', 'happy02', 'happy03', 'happy04', 'happy05', 'happy06',
                    'happy07', 'happy08', 'happy09', 'happy10', 'happy11', 'happy12',
                    'happy13', 'happy14', 'happy15', 'happy16', 'happy17', 'happy18',
                    'sad01', 'sad02', 'sad03', 'sad04', 'sad05', 'sad06', 'sad07', 'sad08', 'sad09'
                ],
                glasses: ['variant01', 'variant02', 'variant03', 'variant04', 'variant05'],
                earrings: ['variant01', 'variant02', 'variant03'],
                beard: ['variant01', 'variant02'],
                hairAccessories: ['flowers'],
                freckles: ['variant01'],
                head: ['variant01', 'variant02', 'variant03', 'variant04'],
                skinColors: ['fdbcbc', 'f8d25c', 'd08b5b', 'ae5d29', '614335'],
                hairColors: ['000000', '2f1b14', '8b4513', 'daa520', 'b8860b', 'ff4500', '800080', 'ff1493', '00ced1', '32cd32'],
                backgroundColors: ['87ceeb', 'transparent','ffffff', 'f0f0f0', 'e6e6fa', 'f0f8ff', 'ff69b4', '98fb98', 'dda0dd', 'ffd700'],
                eyesColors: ['000000', '8b4513', '2563eb', '059669', '7c2d12'],
                eyebrowsColors: ['000000', '8b4513', '2f1b14'],
                glassesColors: ['000000', '1f2937', '374151', '6b7280'],
                earringsColors: ['000000', 'ffd700', 'c0c0c0', 'ff1493'],
                beardColors: ['000000', '8b4513', '2f1b14', 'daa520'],
                frecklesColors: ['000000', '8b4513', 'd08b5b'],
                mouthColors: ['000000', 'dc2626', 'ea580c']
            }
        };
        
        let currentStyle = 'lorelei';
        let currentConfig = {};
        let debounceTimeout;
        
        // Initialize the editor
        function initEditor() {
            setupEventListeners();
            
            // Try to load state from local storage
            if (!loadState()) {
                populateOptions();
                initializeConfig();
            }
            
            updateAvatar();
        }

        function saveState(config) {
            try {
                const state = {
                    style: currentStyle,
                    config: config,
                    currentConfig: currentConfig, // Save the internal config state too (for colors)
                    timestamp: Date.now()
                };
                localStorage.setItem('basherAvatarEditorState', JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
            }
        }

        function loadState() {
            const saved = localStorage.getItem('basherAvatarEditorState');
            if (!saved) return false;
            
            try {
                const state = JSON.parse(saved);
                
                // Restore style
                if (state.style) {
                    currentStyle = state.style;
                    // Update style selector UI
                    document.querySelector('.style-option.active')?.classList.remove('active');
                    const newActive = document.querySelector(`.style-option[data-style="${currentStyle}"]`);
                    if (newActive) newActive.classList.add('active');
                }
                
                // Populate options for the restored style
                populateOptions();
                
                const config = state.config;
                if (!config) return false;

                // Restore internal config
                if (state.currentConfig) {
                    currentConfig = state.currentConfig;
                }
                
                // Restore inputs
                if (config.seed) document.getElementById('seedInput').value = config.seed;
                if (config.size) {
                    document.getElementById('sizeInput').value = config.size;
                    document.getElementById('sizeValue').textContent = config.size + 'px';
                }
                if (config.scale) {
                    document.getElementById('scaleInput').value = config.scale;
                    document.getElementById('scaleValue').textContent = config.scale + '%';
                }
                if (config.rotate) {
                    document.getElementById('rotateInput').value = config.rotate;
                    document.getElementById('rotateValue').textContent = config.rotate + '°';
                }
                if (config.radius) {
                    document.getElementById('radiusInput').value = config.radius;
                    document.getElementById('radiusValue').textContent = config.radius + '%';
                }
                if (config.backgroundType) document.getElementById('backgroundType').value = config.backgroundType;
                
                // Restore radio buttons
                ['hair', 'eyes', 'eyebrows', 'nose', 'mouth', 'head', 'glasses', 'earrings', 'beard', 'hairAccessories', 'freckles'].forEach(key => {
                    if (config[key] && config[key].length > 0) {
                        const val = config[key][0];
                        const radio = document.getElementById(`${key}_${val}`);
                        if (radio) {
                            radio.checked = true;
                            // Manually trigger visual update since we're not dispatching event for all
                            const container = document.getElementById(key + 'Styles');
                            if (container) {
                                const radioContainer = container.querySelector('.grid');
                                if (radioContainer) {
                                    radioContainer.querySelectorAll('.group').forEach(div => {
                                        div.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                                    });
                                    radio.parentElement.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                                }
                            }
                        }
                    }
                });
                
                // Restore colors UI
                 ['backgroundColor'].forEach(key => {
                    const colorVal = currentConfig[key] || (config[key] && config[key][0]);
                    if (colorVal) {
                        const container = document.getElementById(key + 's');
                        if (container) {
                            const pickers = container.querySelectorAll('.color-picker');
                            pickers.forEach(p => {
                                const firstDiv = p.querySelector('div:first-child');
                                if (firstDiv) firstDiv.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                            });
                            
                            // Try to find matching preset
                            let found = false;
                            pickers.forEach(p => {
                                const colorDiv = p.querySelector('div[style*="background-color"]');
                                if (colorDiv) {
                                    const style = colorDiv.getAttribute('style');
                                    const match = style.match(/#([0-9a-f]{6})/i);
                                    if (match && match[1].toLowerCase() === colorVal.toLowerCase()) {
                                        p.querySelector('div:first-child').classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                                        found = true;
                                    }
                                } else if (colorVal === 'transparent' && p.textContent.includes('transparent')) {
                                    p.querySelector('div:first-child').classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                                    found = true;
                                }
                            });
                            
                            // If not found in presets, it might be custom.
                            if (!found) {
                                const customText = document.getElementById(`${key}_custom_text`);
                                const customPicker = document.getElementById(`${key}_custom_picker`);
                                if (customText && customPicker) {
                                    customText.value = colorVal;
                                    if (colorVal.match(/^[0-9a-f]{6}$/i)) {
                                         customPicker.value = '#' + colorVal;
                                    }
                                }
                            }
                        }
                    }
                });

                return true;
            } catch (e) {
                console.error("Failed to load state", e);
                return false;
            }
        }
        
        function setupEventListeners() {
            // Style selector
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    document.querySelector('.style-option.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentStyle = e.target.dataset.style;
                    populateOptions();
                    updateAvatar();
                });
            });
            
            // Basic controls
            ['seedInput', 'sizeInput', 'scaleInput', 'rotateInput', 'radiusInput', 'backgroundType'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounceUpdate);
                }
            });
            
            // Range sliders
            setupRangeSliders();
        }
        
        function setupRangeSliders() {
            const ranges = [
                'sizeInput', 'scaleInput', 'rotateInput', 'radiusInput'
            ];
            
            ranges.forEach(id => {
                const input = document.getElementById(id);
                const valueSpan = document.getElementById(id.replace('Input', 'Value').replace('Probability', 'Value'));
                
                if (input && valueSpan) {
                    input.addEventListener('input', (e) => {
                        let value = e.target.value;
                        let suffix = '';
                        
                        if (id.includes('Probability')) {
                            suffix = '%';
                        } else if (id === 'sizeInput') {
                            suffix = 'px';
                        } else if (id === 'scaleInput') {
                            suffix = '%';
                        } else if (id === 'rotateInput') {
                            suffix = '°';
                        } else if (id === 'radiusInput') {
                            suffix = '%';
                        }
                        
                        valueSpan.textContent = value + suffix;
                        debounceUpdate();
                    });
                }
            });
        }
        
        function populateOptions() {
            const config = avatarConfigs[currentStyle];
            if (!config) return;
            
            // Populate all hair styles (48 variants)
            populateCheckboxGroup('hairStyles', config.hair, 'hair');
            
            // Populate all eye styles (24 variants)
            populateCheckboxGroup('eyeStyles', config.eyes, 'eyes');
            
            // Populate eyebrows (13 variants)
            populateCheckboxGroup('eyebrowStyles', config.eyebrows, 'eyebrows');
            
            // Populate nose (6 variants)
            populateCheckboxGroup('noseStyles', config.nose, 'nose');
            
            // Populate all mouth styles
            populateCheckboxGroup('mouthStyles', config.mouth, 'mouth');
            
            // Populate head shapes
            populateCheckboxGroup('headStyles', config.head, 'head');
            
            // Populate accessories with variants
            populateCheckboxGroup('glassesStyles', config.glasses, 'glasses');
            populateCheckboxGroup('earringsStyles', config.earrings, 'earrings');
            populateCheckboxGroup('beardStyles', config.beard, 'beard');
            populateCheckboxGroup('hairAccessoriesStyles', config.hairAccessories, 'hairAccessories');
            populateCheckboxGroup('frecklesStyles', config.freckles, 'freckles');
            
            // Populate color pickers
            populateColorPickers('backgroundColors', config.backgroundColors, 'backgroundColor');
        }
        
        function populateCheckboxGroup(containerId, options, configKey) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-3';
            header.innerHTML = `
                <span class="text-xs font-medium text-slate-400 uppercase tracking-wider dark:text-slate-500">${options.length} options</span>
            `;
            container.appendChild(header);
            
            // Add radio container
            const radioContainer = document.createElement('div');
            radioContainer.className = 'grid grid-cols-[repeat(auto-fit,minmax(100px,1fr))] gap-3 max-h-[240px] overflow-y-auto pr-2';
            
            // Add "None" option
            const noneItem = document.createElement('div');
            noneItem.className = 'group relative flex items-center justify-center p-3 border border-slate-200 rounded-xl cursor-pointer transition-all hover:border-blue-400 hover:shadow-md bg-white dark:bg-slate-800 dark:border-slate-700 dark:hover:border-blue-500';
            noneItem.innerHTML = `
                <input type="radio" name="${configKey}" id="${configKey}_none" value="" class="absolute inset-0 opacity-0 cursor-pointer">
                <div class="flex flex-col items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors dark:bg-slate-700 dark:text-slate-500 dark:group-hover:bg-blue-900/30 dark:group-hover:text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-slate-600 group-hover:text-slate-900 dark:text-slate-400 dark:group-hover:text-slate-200">None</span>
                </div>
            `;
            const noneRadio = noneItem.querySelector('input');
            noneRadio.addEventListener('change', () => {
                // Uncheck all others visually
                radioContainer.querySelectorAll('.group').forEach(div => {
                    div.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                });
                if (noneRadio.checked) {
                    noneItem.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                }
                debounceUpdate();
            });
            radioContainer.appendChild(noneItem);

            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'group relative flex items-center justify-center p-3 border border-slate-200 rounded-xl cursor-pointer transition-all hover:border-blue-400 hover:shadow-md bg-white dark:bg-slate-800 dark:border-slate-700 dark:hover:border-blue-500';
                item.innerHTML = `
                    <input type="radio" name="${configKey}" id="${configKey}_${option}" value="${option}" class="absolute inset-0 opacity-0 cursor-pointer">
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-mono text-[10px] group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors dark:bg-slate-700 dark:text-slate-400 dark:group-hover:bg-blue-900/30 dark:group-hover:text-blue-400">
                            ${option.replace('variant', '')}
                        </div>
                        <span class="text-[10px] font-medium text-slate-500 group-hover:text-slate-900 truncate w-full text-center dark:text-slate-400 dark:group-hover:text-slate-200">${option}</span>
                    </div>
                `;
                
                const radio = item.querySelector('input');
                radio.addEventListener('change', () => {
                    // Uncheck all others visually
                    radioContainer.querySelectorAll('.group').forEach(div => {
                        div.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                    });
                    if (radio.checked) {
                        item.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'border-blue-500', 'bg-blue-50/50', 'dark:bg-blue-900/20', 'dark:border-blue-500', 'dark:ring-offset-slate-900');
                    }
                    debounceUpdate();
                });
                
                radioContainer.appendChild(item);
            });
            
            container.appendChild(radioContainer);
        }
        
        function populateColorPickers(containerId, colors, configKey) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Add custom color input at the top
            const customColorDiv = document.createElement('div');
            customColorDiv.className = 'mb-4 p-4 border border-slate-200 rounded-xl bg-white shadow-sm dark:bg-slate-800 dark:border-slate-700';
            customColorDiv.innerHTML = `
                <label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider dark:text-slate-500">Custom Color</label>
                <div class="flex gap-3 items-center">
                    <div class="relative w-12 h-12 rounded-full overflow-hidden shadow-inner ring-1 ring-slate-200 dark:ring-slate-600">
                        <input type="color" id="${configKey}_custom_picker" class="absolute -top-2 -left-2 w-16 h-16 cursor-pointer p-0 border-0">
                    </div>
                    <div class="flex-1 relative">
                        <span class="absolute left-3 top-2.5 text-slate-400 font-mono text-sm">#</span>
                        <input type="text" id="${configKey}_custom_text" placeholder="000000" class="w-full pl-7 pr-3 py-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm bg-slate-50 focus:bg-white transition-all dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100 dark:focus:bg-slate-800">
                    </div>
                    <button onclick="applyCustomColor('${configKey}')" class="px-4 py-2.5 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all text-sm font-medium shadow-md hover:shadow-lg active:scale-95 dark:bg-blue-600 dark:hover:bg-blue-700">Apply</button>
                </div>
            `;
            
            // Set up custom color input synchronization
            const customPicker = customColorDiv.querySelector(`#${configKey}_custom_picker`);
            const customText = customColorDiv.querySelector(`#${configKey}_custom_text`);
            
            customPicker.addEventListener('input', () => {
                customText.value = customPicker.value.replace('#', '');
            });
            
            customText.addEventListener('input', () => {
                let value = customText.value;
                if (value.match(/^[0-9a-f]{6}$/i)) {
                    customPicker.value = '#' + value;
                }
            });
            
            container.appendChild(customColorDiv);
            
            // Add preset colors section
            const presetDiv = document.createElement('div');
            presetDiv.innerHTML = `<label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider dark:text-slate-500">Preset Colors</label>`;
            
            const colorGrid = document.createElement('div');
            colorGrid.className = 'grid grid-cols-5 gap-3 max-h-[240px] overflow-y-auto pr-2';
            
            colors.forEach((color, index) => {
                const picker = document.createElement('div');
                picker.className = 'color-picker group relative flex flex-col items-center cursor-pointer transition-all hover:scale-110';
                
                // Convert color name to hex for display
                let hexColor = color;
                if (color === 'transparent') {
                    hexColor = 'ffffff';
                } else if (!color.startsWith('#') && /^[0-9a-f]{6}$/i.test(color)) {
                    hexColor = color;
                }
                
                picker.innerHTML = `
                    <div class="w-10 h-10 rounded-full overflow-hidden relative shadow-sm ring-1 ring-slate-200 group-hover:shadow-md transition-all dark:ring-slate-600">
                        ${color === 'transparent' ? 
                            '<div class="w-full h-full bg-white" style="background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 6px 6px; background-position: 0 0, 0 3px, 3px -3px, -3px 0px;"></div>' :
                            `<div class="w-full h-full" style="background-color: #${hexColor}"></div>`
                        }
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-all"></div>
                    </div>
                    <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                        ${color === 'transparent' ? 'Transparent' : `#${hexColor}`}
                    </div>
                `;
                
                picker.addEventListener('click', () => {
                    document.querySelectorAll(`#${containerId} .color-picker div:first-child`).forEach(p => {
                        p.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                    });
                    picker.querySelector('div:first-child').classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                    currentConfig[configKey] = color;
                    debounceUpdate();
                });
                
                // Select first color by default for most properties, transparent for backgroundColor
                if (index === 0 || (configKey === 'backgroundColor' && color === 'transparent')) {
                    picker.querySelector('div:first-child').classList.add('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                }
                
                colorGrid.appendChild(picker);
            });
            
            presetDiv.appendChild(colorGrid);
            container.appendChild(presetDiv);
        }
        
        function applyCustomColor(configKey) {
            const textInput = document.getElementById(`${configKey}_custom_text`);
            let colorValue = textInput.value;
            
            // Validate and normalize the color value
            if (colorValue.match(/^#?[0-9a-f]{6}$/i)) {
                if (colorValue.startsWith('#')) {
                    colorValue = colorValue.substring(1);
                }
                
                // Clear other selections
                const container = document.getElementById(configKey + 'Colors');
                if (container) {
                    container.querySelectorAll('.color-picker div:first-child').forEach(p => {
                        p.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2', 'dark:ring-offset-slate-900');
                    });
                }
                
                // Apply the custom color
                currentConfig[configKey] = colorValue;
                debounceUpdate();
                
                // Show success feedback
                textInput.classList.add('ring-2', 'ring-green-500');
                setTimeout(() => {
                    textInput.classList.remove('ring-2', 'ring-green-500');
                }, 1000);
            } else {
                // Show error feedback
                textInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => {
                    textInput.classList.remove('ring-2', 'ring-red-500');
                }, 1000);
            }
        }

        function initializeConfig() {
            currentConfig = {
                seed: 'custom-avatar',
                size: 200,
                scale: 100,
                rotate: 0,
                radius: 0,
                backgroundType: 'solid'
            };
        }
        
        function debounceUpdate() {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(updateAvatar, 300);
        }
        
        function updateAvatar() {
            const config = gatherCurrentConfig();
            saveState(config);
            const url = buildAvatarUrl(config);
            
            document.getElementById('avatarUrl').value = url;
            
            const img = document.getElementById('avatarImage');
            const loading = document.getElementById('loadingIndicator');
            
            loading.style.display = 'block';
            img.style.display = 'none';
            
            const newImg = new Image();
            newImg.onload = () => {
                img.src = url;
                img.style.display = 'block';
                loading.style.display = 'none';
            };
            newImg.onerror = () => {
                loading.style.display = 'none';
                img.alt = 'Failed to load avatar';
            };
            newImg.src = url;
        }
        
        function gatherCurrentConfig() {
            const config = {
                seed: document.getElementById('seedInput').value || 'custom-avatar',
                size: document.getElementById('sizeInput').value,
                scale: document.getElementById('scaleInput').value,
                rotate: document.getElementById('rotateInput').value,
                radius: document.getElementById('radiusInput').value,
                backgroundType: document.getElementById('backgroundType').value
            };
            
            // Gather selected options from radio buttons
            ['hair', 'eyes', 'eyebrows', 'nose', 'mouth', 'head', 'glasses', 'earrings', 'beard', 'hairAccessories', 'freckles'].forEach(key => {
                const selected = document.querySelector(`input[name="${key}"]:checked`);
                if (selected && selected.value) {
                    config[key] = [selected.value];

                    // Set probability to 100% for accessories to ensure they appear
                    if (['glasses', 'earrings', 'beard', 'hairAccessories', 'freckles'].includes(key)) {
                        config[key + 'Probability'] = 100;
                    }
                }
            });
            
            // Gather selected colors
            ['backgroundColor'].forEach(key => {
                // Check if there's a value already set in currentConfig (from custom color or preset selection)
                if (currentConfig[key]) {
                    // Convert single color to array format expected by DiceBear
                    if (typeof currentConfig[key] === 'string') {
                        config[key] = [currentConfig[key]];
                    }
                } else {
                    // Fallback to checking for selected preset colors
                    const container = document.getElementById(key + 's');
                    const selected = container ? container.querySelector('.color-picker.ring-2') : null;
                    if (selected) {
                        const colorDiv = selected.querySelector('div[style*="background-color"]');
                        if (colorDiv) {
                            const style = colorDiv.getAttribute('style');
                            const match = style.match(/#([0-9a-f]{6})/i);
                            if (match) {
                                config[key] = [match[1]];
                            }
                        } else if (selected.textContent.includes('transparent')) {
                            config[key] = ['transparent'];
                        }
                    }
                }
            });
            
            return config;
        }
        
        function buildAvatarUrl(config) {
            const baseUrl = `https://api.dicebear.com/9.x/${currentStyle}/svg`;
            const params = new URLSearchParams();
            
            Object.keys(config).forEach(key => {
                const value = config[key];
                if (Array.isArray(value)) {
                    value.forEach(v => params.append(key, v));
                } else {
                    params.append(key, value);
                }
            });
            
            return `${baseUrl}?${params.toString()}`;
        }
        
        function randomizeAvatar() {
            document.getElementById('seedInput').value = 'seed_' + Math.random().toString(36).substr(2, 9);
            
            // Randomize some sliders
            document.getElementById('scaleInput').value = Math.floor(Math.random() * 50) + 75;
            document.getElementById('rotateInput').value = Math.floor(Math.random() * 360);
            document.getElementById('radiusInput').value = Math.floor(Math.random() * 25);
            
            // Trigger updates for sliders
            document.querySelectorAll('.form-range').forEach(input => {
                input.dispatchEvent(new Event('input'));
            });
            
            updateAvatar();
        }
        
        function generateNewSeed() {
            document.getElementById('seedInput').value = 'avatar_' + Date.now();
            updateAvatar();
        }
        
        function copyToClipboard() {
            const url = document.getElementById('avatarUrl');
            url.select();
            document.execCommand('copy');
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }
        
        function downloadAvatar() {
            const url = document.getElementById('avatarUrl').value;
            const link = document.createElement('a');
            link.href = url;
            link.download = `avatar-${Date.now()}.svg`;
            link.click();
        }
        
        function downloadSVG() {
            downloadAvatar();
        }
        
        function downloadPNG() {
            const svgUrl = document.getElementById('avatarUrl').value;
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = this.width;
                canvas.height = this.height;
                
                ctx.drawImage(this, 0, 0);
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `avatar-${Date.now()}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png');
            };
            
            img.src = svgUrl;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initEditor);
    </script>
</body>
</html>
